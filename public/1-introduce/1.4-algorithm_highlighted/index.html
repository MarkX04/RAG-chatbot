<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.148.2"><meta name=description content><meta name=author content="journeyoftheaverageguy@gmail.com"><link rel=icon href=https://markx04.github.io/RAG-chatbot/images/favicon.png type=image/png><title>PDF Text Highlighting Algorithm using PyMuPDF Library :: AWS System Manager</title><link href=https://markx04.github.io/RAG-chatbot/css/nucleus.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/fontawesome-all.min.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/hybrid.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/featherlight.min.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/perfect-scrollbar.min.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/auto-complete.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/atom-one-dark-reasonable.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/theme.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/hugo-theme.css?1754534565 rel=stylesheet><link href=https://markx04.github.io/RAG-chatbot/css/theme-workshop.css?1754534565 rel=stylesheet><script src=https://markx04.github.io/RAG-chatbot/js/jquery-3.3.1.min.js?1754534565></script><style>:root #header+#content>#left>#rlblock_left{display:none !important}</style></head><body data-url=https://markx04.github.io/RAG-chatbot/1-introduce/1.4-algorithm_highlighted/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://markx04.github.io/RAG-chatbot/><svg id="Layer_1" data-name="Layer 1" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff}.cls-2{fill:#f90;fill-rule:evenodd}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09 10.85a4.7 4.7.0 00.19 1.48 7.73 7.73.0 00.54 1.19.77.77.0 01.12.38.64.64.0 01-.32.49l-1 .7a.83.83.0 01-.44.15.69.69.0 01-.49-.23 3.8 3.8.0 01-.6-.77q-.25-.42-.51-1a6.14 6.14.0 01-4.89 2.3 4.54 4.54.0 01-3.32-1.19 4.27 4.27.0 01-1.22-3.2 4.28 4.28.0 011.46-3.4A6.06 6.06.0 017.69 6.46a12.47 12.47.0 011.76.13q.92.13 1.91.36V5.73a3.65 3.65.0 00-.79-2.66A3.81 3.81.0 007.86 2.3a7.71 7.71.0 00-1.79.22 12.78 12.78.0 00-1.79.57 4.55 4.55.0 01-.58.22h-.26q-.35.0-.35-.52V2a1.09 1.09.0 01.12-.58 1.2 1.2.0 01.47-.35A10.88 10.88.0 015.77.32 10.19 10.19.0 018.36.0a6 6 0 014.35 1.35 5.49 5.49.0 011.38 4.09zM7.34 13.38a5.36 5.36.0 001.72-.31A3.63 3.63.0 0010.63 12 2.62 2.62.0 0011.19 11a5.63 5.63.0 00.16-1.44v-.7a14.35 14.35.0 00-1.53-.28 12.37 12.37.0 00-1.56-.1 3.84 3.84.0 00-2.47.67A2.34 2.34.0 005 11a2.35 2.35.0 00.61 1.76A2.4 2.4.0 007.34 13.38zm13.35 1.8a1 1 0 01-.64-.16 1.3 1.3.0 01-.35-.65L15.81 1.51a3 3 0 01-.15-.67.36.36.0 01.41-.41H17.7a1 1 0 01.65.16 1.4 1.4.0 01.33.65l2.79 11 2.59-11A1.17 1.17.0 0124.39.6a1.1 1.1.0 01.67-.16H26.4a1.1 1.1.0 01.67.16 1.17 1.17.0 01.32.65L30 12.39 32.88 1.25A1.39 1.39.0 0133.22.6a1 1 0 01.65-.16h1.54a.36.36.0 01.41.41 1.36 1.36.0 010 .26 3.64 3.64.0 01-.12.41l-4 12.86a1.3 1.3.0 01-.35.65 1 1 0 01-.64.16H29.25a1 1 0 01-.67-.17 1.26 1.26.0 01-.32-.67L25.67 3.64l-2.56 10.7a1.26 1.26.0 01-.32.67 1 1 0 01-.67.17zm21.36.44a11.28 11.28.0 01-2.56-.29 7.44 7.44.0 01-1.92-.67 1 1 0 01-.61-.93v-.84q0-.52.38-.52a.9.9.0 01.31.06l.42.17a8.77 8.77.0 001.83.58 9.78 9.78.0 002 .2 4.48 4.48.0 002.43-.55 1.76 1.76.0 00.86-1.57 1.61 1.61.0 00-.45-1.16A4.29 4.29.0 0043 9.22l-2.41-.76A5.15 5.15.0 0138 6.78a3.94 3.94.0 01-.83-2.41 3.7 3.7.0 01.45-1.85 4.47 4.47.0 011.19-1.37 5.27 5.27.0 011.7-.86A7.4 7.4.0 0142.6.0a8.87 8.87.0 011.12.07q.57.07 1.08.19t.95.26a4.27 4.27.0 01.7.29 1.59 1.59.0 01.49.41.94.94.0 01.15.55v.79q0 .52-.38.52a1.76 1.76.0 01-.64-.2 7.74 7.74.0 00-3.2-.64 4.37 4.37.0 00-2.21.47 1.6 1.6.0 00-.79 1.48 1.58 1.58.0 00.49 1.18 4.94 4.94.0 001.83.92L44.55 7a5.08 5.08.0 012.57 1.6A3.76 3.76.0 0147.9 11a4.21 4.21.0 01-.44 1.93 4.4 4.4.0 01-1.21 1.47 5.43 5.43.0 01-1.85.93A8.25 8.25.0 0142.05 15.62z"/><path class="cls-2" d="M45.19 23.81C39.72 27.85 31.78 30 25 30A36.64 36.64.0 01.22 20.57c-.51-.46-.06-1.09.56-.74A49.78 49.78.0 0025.53 26.4 49.23 49.23.0 0044.4 22.53C45.32 22.14 46.1 23.14 45.19 23.81z"/><path class="cls-2" d="M47.47 21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74 3.13-2.2 8.27-1.57 8.86-.83s-.16 5.89-3.09 8.35c-.45.38-.88.18-.68-.32C46.69 25.8 48.17 22.11 47.47 21.21z"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=https://markx04.github.io/RAG-chatbot/js/lunr.min.js?1754534565></script><script type=text/javascript src=https://markx04.github.io/RAG-chatbot/js/auto-complete.js?1754534565></script><script type=text/javascript>var baseurl="https://markx04.github.io/RAG-chatbot/"</script><script type=text/javascript src=https://markx04.github.io/RAG-chatbot/js/search.js?1754534565></script></div><div class=highlightable><ul class=topics><li data-nav-id=/1-introduce/ title=Theory class="dd-item
parent"><a href=https://markx04.github.io/RAG-chatbot/1-introduce/><b>1. </b>Theory
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/1-introduce/1.1-llm/ title="Theory of Large Language Models" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/1-introduce/1.1-llm/><b>1.1 </b>Theory of Large Language Models
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-introduce/1.2-embedding/ title="Theory of Embeddings for Storage" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/1-introduce/1.2-embedding/><b>1.2 </b>Theory of Embeddings for Storage
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-introduce/1.3-rag/ title="Theory of Retrieval-Augmented Generation" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/1-introduce/1.3-rag/><b>1.3 </b>Theory of Retrieval-Augmented Generation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-introduce/1.4-algorithm_highlighted/ title="PDF Text Highlighting Algorithm using PyMuPDF Library" class="dd-item
active"><a href=https://markx04.github.io/RAG-chatbot/1-introduce/1.4-algorithm_highlighted/><b>1.4 </b>PDF Text Highlighting Algorithm using PyMuPDF Library
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/2-prerequiste/ title="Preparation Steps" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/2-prerequiste/><b>2. </b>Preparation Steps
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/2-prerequiste/2.1-bedrock/ title="Enabling Large Language and Embedding Models" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/2-prerequiste/2.1-bedrock/><b>2.1</b> Enabling Large Language and Embedding Models
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.2-gemini/ title="Enabling the Gemini Large Language Model" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/2-prerequiste/2.2-gemini/><b>2.2</b> Enabling the Gemini Large Language Model
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.3-iam/ title="Create IAM Role with Required Permissions" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/2-prerequiste/2.3-iam/><b>2.3</b> Create IAM Role with Required Permissions
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/3-setupec2/ title="Create EC2 Instance" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/3-setupec2/><b>3. </b>Create EC2 Instance
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-setupfrondend_s3/ title="Initialize Front End" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/4-setupfrondend_s3/><b>4. </b>Initialize Front End
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/4-setupfrondend_s3/4.1-awsconfigure/ title="Configure AWS" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/4-setupfrondend_s3/4.1-awsconfigure/><b>4.1 </b>Configure AWS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-setupfrondend_s3/4.2-deployfrondend/ title="Deploy Frontend to Amazon S3" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/4-setupfrondend_s3/4.2-deployfrondend/><b>4.2 </b>Deploy Frontend to Amazon S3
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-setupfrondend_s3/4.3-configres3/ title="Configure Amazon S3" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/4-setupfrondend_s3/4.3-configres3/><b>4.3 </b>Configure Amazon S3
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/5-setupbackend/ title="Set Up BackEnd" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/5-setupbackend/><b>5. </b>Set Up BackEnd
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/5-setupbackend/5.1-builddocker/ title="Build Docker from Local" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/5-setupbackend/5.1-builddocker/><b>5.1 </b>Build Docker from Local
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-setupbackend/5.2-use/ title="Using RAG" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/5-setupbackend/5.2-use/><b>5.2 </b>Using RAG
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/6-eraseresource/ title="Delete Resources" class=dd-item><a href=https://markx04.github.io/RAG-chatbot/6-eraseresource/><b>6. </b>Delete Resources
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://www.facebook.com/groups/awsstudygroupfcj/><i class='fab fa-facebook'></i> AWS Study Group</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=en value=https://markx04.github.io/RAG-chatbot/1-introduce/1.4-algorithm_highlighted/ selected>English</option><option id=vi value=https://markx04.github.io/RAG-chatbot/vi/1-introduce/1.4-algorithm_highlighted/>Tiếng Việt</option></select>
<svg id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><left><b>Workshop</b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title=Migrate alt="web counter" border=0></a><br><b><a href=https://cloudjourney.awsstudygroup.com/>Cloud Journey</a></b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" alt="web counter" border=0>
</left><left><br><br><b>Last Updated</b><br><i><font color=orange>30-01-2022</font></i>
</left><left><br><br><b>Team</b><br><i><a href=https://www.linkedin.com/in/daiphamcs/ style=color:orange>Bảo Đại</a><br><a href=https://www.linkedin.com/in/nguy%E1%BB%85n-ti%E1%BA%BFn-h%C6%B0ng-629359364/ style=color:orange>Tiến Hưng</a><br></i></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=https://markx04.github.io/RAG-chatbot/>Retrieval-Augmented Generation highlight</a> > <a href=https://markx04.github.io/RAG-chatbot/1-introduce/>Theory</a> > PDF Text Highlighting Algorithm using PyMuPDF Library</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#how-to-highlight-text-in-pdf-with-pymupdf>How to Highlight Text in PDF with PyMuPDF</a><ul><li><a href=#find-text-positions-using-search_for>Find text positions using <code>.search_for()</code></a></li><li><a href=#solution-fuzzy-matching-for-inexact-highlighting>Solution: Fuzzy Matching for Inexact Highlighting</a></li><li><a href=#partial_highlight-algorithm><code>partial_highlight()</code> Algorithm</a></li><li><a href=#helper-function-find_spans_fuzzy>Helper Function: <code>find_spans_fuzzy()</code></a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>PDF Text Highlighting Algorithm using PyMuPDF Library</h1><h2 id=introduction>Introduction</h2><p>When working with PDF documents in Python, highlighting text is a common operation — especially in applications involving information extraction, marking important data, or displaying search results. In this article, we’ll explore how to highlight text in a PDF file using the <a href=https://pymupdf.readthedocs.io/>PyMuPDF (fitz)</a> library.</p><h2 id=how-to-highlight-text-in-pdf-with-pymupdf>How to Highlight Text in PDF with PyMuPDF</h2><h3 id=find-text-positions-using-search_for>Find text positions using <code>.search_for()</code></h3><p>First, you need to open the PDF document and find the text fragments to highlight using the <code>.search_for()</code> function of a <code>Page</code> object. This function returns a list of <code>Rect</code> objects corresponding to the positions of the found text.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> fitz  <span style=color:#75715e># PyMuPDF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Open the PDF file</span>
</span></span><span style=display:flex><span>doc <span style=color:#f92672>=</span> fitz<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;example.pdf&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Iterate through each page</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> page <span style=color:#f92672>in</span> doc:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Search for the positions matching the search string</span>
</span></span><span style=display:flex><span>    text_instances <span style=color:#f92672>=</span> page<span style=color:#f92672>.</span>search_for(<span style=color:#e6db74>&#34;highlight me&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Highlight each found region</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> inst <span style=color:#f92672>in</span> text_instances:
</span></span><span style=display:flex><span>        highlight <span style=color:#f92672>=</span> page<span style=color:#f92672>.</span>add_highlight_annot(inst)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Save the result</span>
</span></span><span style=display:flex><span>doc<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#34;highlighted.pdf&#34;</span>, garbage<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, deflate<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><div class="notices tip"><p>Large language models can return answers in a JSON format.</p></div><p>Example:</p><pre tabindex=0><code>[
  {{ &#34;chunk_id&#34;: ..., &#34;highlight_text&#34;: &#34;...&#34; }},
  ...
]
</code></pre><div class="notices tip"><p>Based on this capability, when sending a prompt to any large language model, you can ask it to return its answer along with a JSON format for the text that should be highlighted. This means the highlight functionality heavily depends on the language model&rsquo;s output.</p></div><div class="notices warning"><p>However, the nature of large language models is generative. They do not always guarantee the exact output format or text (e.g., in this application, they might return text that differs slightly from the exact original text in the PDF). Since .search_for() requires an exact match in characters and formatting, relying solely on the language model means the highlighting will only work for a subset of prompts — not consistently.</p></div><ul><li><strong>One solution</strong> to this issue is to write an algorithm that handles cases where the language model returns slightly altered text compared to the original in the PDF.</li></ul><h3 id=solution-fuzzy-matching-for-inexact-highlighting>Solution: Fuzzy Matching for Inexact Highlighting</h3><p>We will use a <strong>fuzzy matching algorithm</strong> to find approximate text matches on a PDF page, then create highlights for the matched regions.</p><h3 id=partial_highlight-algorithm><code>partial_highlight()</code> Algorithm</h3><p>Below is the <code>partial_highlight()</code> function, which helps find approximate text and apply highlights, even when exact matches aren’t found:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>partial_highlight</span>(pdf_path, output_path, text_to_highlight, page_number, file_exist, threshold<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>):
</span></span><span style=display:flex><span>    doc <span style=color:#f92672>=</span> fitz<span style=color:#f92672>.</span>open(pdf_path)
</span></span><span style=display:flex><span>    page <span style=color:#f92672>=</span> doc[page_number]
</span></span><span style=display:flex><span>    page_text <span style=color:#f92672>=</span> page<span style=color:#f92672>.</span>get_text()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Clean the input text</span>
</span></span><span style=display:flex><span>    target_text <span style=color:#f92672>=</span> text_to_highlight<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>n&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Find approximate matches using fuzzy matching</span>
</span></span><span style=display:flex><span>    spans <span style=color:#f92672>=</span> find_spans_fuzzy(page, target_text, threshold)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> spans:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;--------------Failed to find highlight partial!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> span <span style=color:#f92672>in</span> spans:
</span></span><span style=display:flex><span>            highlight <span style=color:#f92672>=</span> page<span style=color:#f92672>.</span>add_highlight_annot(span)
</span></span><span style=display:flex><span>            highlight<span style=color:#f92672>.</span>update()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;------------------Partial highlight checking---------------&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Save the PDF to disk</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> file_exist:
</span></span><span style=display:flex><span>        temp_output <span style=color:#f92672>=</span> output_path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.temp.pdf&#34;</span>
</span></span><span style=display:flex><span>        doc<span style=color:#f92672>.</span>save(temp_output, garbage<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, deflate<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, clean<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        doc<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>        shutil<span style=color:#f92672>.</span>move(temp_output, output_path)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        doc<span style=color:#f92672>.</span>save(output_path, garbage<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>, deflate<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, clean<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        doc<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><h3 id=helper-function-find_spans_fuzzy>Helper Function: <code>find_spans_fuzzy()</code></h3><p>This function loops through all words on a PDF page and performs <strong>fuzzy matching</strong> using a sliding window approach to locate regions with similar text:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fuzzywuzzy <span style=color:#f92672>import</span> fuzz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_spans_fuzzy</span>(page, target, threshold<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>, buffer<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>):
</span></span><span style=display:flex><span>    spans <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    words <span style=color:#f92672>=</span> page<span style=color:#f92672>.</span>get_text(<span style=color:#e6db74>&#34;words&#34;</span>)  <span style=color:#75715e># Each word is (x0, y0, x1, y1, word, block_no, line_no, word_no)</span>
</span></span><span style=display:flex><span>    words<span style=color:#f92672>.</span>sort(key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> w: (w[<span style=color:#ae81ff>1</span>], w[<span style=color:#ae81ff>0</span>]))  <span style=color:#75715e># Sort by position: top-to-bottom, left-to-right</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    word_texts <span style=color:#f92672>=</span> [w[<span style=color:#ae81ff>4</span>] <span style=color:#66d9ef>for</span> w <span style=color:#f92672>in</span> words]
</span></span><span style=display:flex><span>    target_len <span style=color:#f92672>=</span> len(target<span style=color:#f92672>.</span>split())
</span></span><span style=display:flex><span>    max_window <span style=color:#f92672>=</span> min(len(words), target_len <span style=color:#f92672>+</span> buffer)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(words) <span style=color:#f92672>-</span> max_window <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> window <span style=color:#f92672>in</span> range(target_len, max_window <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>            window_words <span style=color:#f92672>=</span> word_texts[i:i<span style=color:#f92672>+</span>window]
</span></span><span style=display:flex><span>            window_text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(window_words)
</span></span><span style=display:flex><span>            score <span style=color:#f92672>=</span> fuzz<span style=color:#f92672>.</span>partial_ratio(window_text, target)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> score <span style=color:#f92672>&gt;=</span> threshold:
</span></span><span style=display:flex><span>                rects <span style=color:#f92672>=</span> [fitz<span style=color:#f92672>.</span>Rect(w[:<span style=color:#ae81ff>4</span>]) <span style=color:#66d9ef>for</span> w <span style=color:#f92672>in</span> words[i:i<span style=color:#f92672>+</span>window]]
</span></span><span style=display:flex><span>                span <span style=color:#f92672>=</span> rects[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> r <span style=color:#f92672>in</span> rects[<span style=color:#ae81ff>1</span>:]:
</span></span><span style=display:flex><span>                    span <span style=color:#f92672>|=</span> r  <span style=color:#75715e># union all rectangles</span>
</span></span><span style=display:flex><span>                spans<span style=color:#f92672>.</span>append(span)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>  <span style=color:#75715e># Stop checking longer windows at this position once a match is found</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> spans
</span></span></code></pre></div><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=https://markx04.github.io/RAG-chatbot/1-introduce/1.3-rag/ title="Theory of Retrieval-Augmented Generation"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=https://markx04.github.io/RAG-chatbot/2-prerequiste/ title="Preparation Steps" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=https://markx04.github.io/RAG-chatbot/js/clipboard.min.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/perfect-scrollbar.min.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/perfect-scrollbar.jquery.min.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/jquery.sticky.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/featherlight.min.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/highlight.pack.js?1754534565></script><script>hljs.initHighlightingOnLoad()</script><script src=https://markx04.github.io/RAG-chatbot/js/modernizr.custom-3.6.0.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/learn.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/image-handler.js?1754534565></script><script src=https://markx04.github.io/RAG-chatbot/js/hugo-learn.js?1754534565></script><link href=https://markx04.github.io/RAG-chatbot/mermaid/mermaid.css?1754534565 rel=stylesheet><script src=https://markx04.github.io/RAG-chatbot/mermaid/mermaid.js?1754534565></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-158079754-2","auto"),ga("send","pageview")</script></body></html>